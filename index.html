<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Bible Reader</title>
  <link rel="stylesheet" href="css/jquery-ui.css">
  <script src="js/jquery.js"></script>
  <script src="js/jquery-ui.js"></script>
  <script>
  
  var books = [
    // Old Testament
    // Pentateuch of Moses
    { name: "Gen" },
    { name: "Ex" },
    { name: "Lev" },
    { name: "Num" },
    { name: "Deut", chaptersCount: 34, startDate: "17/11", endDate: "3/12" },

    // Historical Books
    { name: "Nav", chaptersCount: 24, startDate: "4/12", endDate: "15/12" },
    { name: "Judg", chaptersCount: 21, startDate: "16/12", endDate: "26/12" },
    { name: "Rth", chaptersCount: 4, startDate: "27/12", endDate: "28/12" },
    { name: "1Sam", chaptersCount: 31, startDate: "29/12", endDate: "14/1" },
    { name: "2Sam" },
    { name: "1King" },
    { name: "2King" },
    { name: "1Chron" },
    { name: "2Chron" },
    { name: "Ezr" },
    { name: "1Ezr" },
    { name: "2Ezr" },
    { name: "Nehem" },
    { name: "Tov" },
    { name: "Judf" },
    { name: "Est" },
    { name: "1Mak" },
    { name: "2Mak" },
    { name: "3Mak" },
    
    // Teaching Books
    { name: "job" },
    { name: "Ps", chaptersCount: 151, startDate: "22/10", endDate: "21/3" },
    { name: "Prov" },
    { name: "Eccl" },
    { name: "Song" },
    { name: "Solom" },
    { name: "Sir" },
    
    // Prophets' Books
    { name: "Lam" },
    { name: "pJer" },
    { name: "Is" },
    { name: "Jer" },
    { name: "Bar" },
    { name: "Ezek" },
    { name: "Dan" },
    { name: "Hos" },
    { name: "Joel" },
    { name: "Am" },
    { name: "Avd" },
    { name: "Jona" },
    { name: "Mic" },
    { name: "Naum" },
    { name: "Habak" },
    { name: "Sofon" },
    { name: "Hag" },
    { name: "Zah" },
    { name: "Mal" },
    
    // New Testament
    { name: "Act", chaptersCount: 28, startDate: "30/11", endDate: "27/12" },
    { name: "Jac", chaptersCount: 5, startDate: "28/12", endDate: "1/1" }
  ];
  
  
  
  $(function() {
    $("#datepicker").datepicker({
      onSelect: function(dateText) {
	generateLinks();      
      }
    });
      
      
    $("#datepicker").datepicker("setDate", new Date());
	
    generateLinks();	
  });
  
  function buildLink(name, chapter)
  {
    return "<a href=\"http://azbyka.ru/biblia/?" + name + "."+chapter+
      "\">http://azbyka.ru/biblia/?" + name + "." + chapter + "</a><br/>";
  }
  
  function generateLinks()
  {
    $("#links").text("");
    
    var selectedDate = $("#datepicker").datepicker( 'getDate' );
    
    for (var i = 0; i < books.length; ++i) {
      var book = books[i];
      
      if (!book.chaptersCount || !book.startDate || !book.endDate) {
	// Book data hasnt been entered
	continue;
      }
      
      var parts = book.startDate.split('/');
      var startDay = parseInt(parts[0]);
      var startMonth = parseInt(parts[1]);
      
      parts = book.endDate.split('/');
      var endDay = parseInt(parts[0]);
      var endMonth = parseInt(parts[1]);
      
      var today = new Date();
      var startDate, endDate;
      if (endMonth >= startMonth) {
	// Both start and end date lie within one year
	startDate = new Date(today.getFullYear(), startMonth - 1, startDay);
	endDate = new Date(today.getFullYear(), endMonth - 1, endDay);
      } else {
	// End date starts in the next year
	startDate = new Date(today.getFullYear(), startMonth - 1, startDay);
	endDate = new Date(today.getFullYear() + 1, endMonth - 1, endDay);
      }
      
      if (selectedDate < startDate || selectedDate > endDate) {
	// Selected date is beyond the book reading frame
	continue;
      }
      
      // Selected date is inside the book reading frame
      // Determine what chapters to read
      var totalDays = 1 + Math.round((endDate - startDate) / 86400000);
      var daysFromStart = Math.round((selectedDate - startDate) / 86400000);
      
      var twoChapters = book.chaptersCount >= totalDays * 2;
      
      var startChapter = 1 + Math.round(book.chaptersCount * daysFromStart / totalDays);
      
      // First link
      $("#links").append(buildLink(book.name, startChapter));
      
      if (twoChapters) {
	$("#links").append(buildLink(book.name, startChapter + 1));
      }
    }   
  }
  
  </script>
</head>
<body>
 
<p>Date: <input type="text" id="datepicker"></p>
<p id="links"></p>
 
 
</body>
</html>